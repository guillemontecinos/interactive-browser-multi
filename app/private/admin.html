<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Admin</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
</head>
<body>
    <script>
        // Interactive Browser Multiuser - Admin
        // by Guillermo Montecinos

        // Source: https://socket.io/docs/#Using-with-Express
        // TODO: update this address with the current IP
        let url = location.host.split(':')[0]
        let socket = io.connect(url)
        socket.emit('nickname', 'admin')

        let clients = []

        socket.on('new client to admin', function(data){
            console.log(data)
            // create a div that stores the canvas
            let container = document.createElement('div')
            let name = document.createElement('div')
            name.className = 'user-name'
            name.innerHTML = data.username
            let sketch = document.createElement('div')
            sketch.id = data.id
            container.appendChild(name)
            container.appendChild(sketch)
            document.body.appendChild(container)
            // saves the data in the clients array
            clients.push({id: data.id, username: data.username, instance: new p5(s, document.getElementById(data.id)), shape: []})
            // console.log(clients)
        })

        socket.on('disconnect to admin', function(data){
            // get rid of the container
            document.getElementById(data.id).parentElement.remove()
            // remove client from the clients array
            let index = clients.findIndex(element => element.id === data.id)
            clients.splice(index, 1)
            // console.log(clients)
        })

        socket.on('data to admin', function(data){
            let index = clients.findIndex(element => element.id === data.id)
            // update circle position of the client
            console.log(clients[index].shape)
            if(data.action == 'start'){
                clients[index].shape.push([])
                pointReceived(clients[index], data)
            }
            else if(data.action == 'dragged'){
                pointReceived(clients[index], data)
            }
            else if(data.action == 'reset'){
                resetClient(clients[index])
            }
        })

        function pointReceived(element, data){
            element.shape[element.shape.length - 1].push({x: data.x, y: data.y})
            let aux = element.shape[element.shape.length - 1]
            if(aux.length >= 2) element.instance.line(aux[aux.length - 2].x * element.instance.width, aux[aux.length - 2].y * element.instance.height, aux[aux.length - 1].x * element.instance.width, aux[aux.length - 1].y * element.instance.height)
        }

        function resetClient(element){
            element.instance.background(255)
            element.instance.rect(0, 0, element.instance.width, element.instance.height)
            element.shape = []
        }

        // declare constructor for each canvas visualizator
        const s = function(sketch){
            sketch.setup = function(){
                sketch.createCanvas(400, 250)
                sketch.strokeWeight(3)
                sketch.rect(0, 0, sketch.width, sketch.height)
            }
        }
    </script>
</body>
</html>